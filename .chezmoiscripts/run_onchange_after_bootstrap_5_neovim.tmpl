#! /usr/bin/env bash

# This script should install all necessary packages and tools for 
# the "neovim" version of the dotfiles

{{ if not (has "neovim" .global.roles)  -}}
exit 0
{{ end -}}

echo "bootstrap neovim"

source "${HOME}/bin/helper.sh"

if is_zsh; then
	echo "Running under zsh"
fi

echo "Installing dependency packages"
if is_mac; then
	desired=(cmake shellcheck@0.9 shfmt@1.33 universal-ctags
		fontconfig@2.14)
	missing=()
	check_brewed "missing" "${desired[@]}"
	if [[ "${#missing[@]}" -gt 0 ]]; then
		echo "(brew) installing ${missing[*]}"
		brew install "${missing[@]}"
	fi
else
	desired=(curl jq git unzip fontconfig build-essential
		libfontconfig1-dev
		libx11-xcb-dev
		libxcb-render0-dev 
		libxcb-shape0-dev 
		libxcb-xfixes0-dev 
		libharfbuzz-dev)
		# libfreetype-dev libfreetype6
		# libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev
		# libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev
	missing=()
	check_dpkged "missing" "${desired[@]}"
	if [[ "${#missing[@]}" -gt 0 ]]; then
		echo "(apt) installing ${missing[*]}"
		sudo apt-get -y update
		sudo apt-get -y install "${missing[@]}"
	fi
fi

cd "${HOME}" || exit
# version manager for tools
if [[ ! -f "${HOME}/bin/mise" ]] || ! "${HOME}/bin/mise" --version >/dev/null 2>&1; then
	source "${HOME}/bin/update_mise.sh"
fi

# if we do not set those paths here, then all installed binaries
# that were installed using mise, cannot be found. We want to be able
# to rerun this script multiple times without errors
source "${HOME}/.path.d/10_rust.bash"
source "${HOME}/.path.d/50_mise.bash"
source "${HOME}/.path.d/99_default.sh"
eval "$(mise hook-env)"

# python is needed for installation of Mason packages as well
if ! grep -qs python ~/.config/mise/config.toml; then
	source "${HOME}/bin/install_python.sh"
fi

{{- if eq .global.neovim "full" }}

if ! rustup -V >/dev/null 2>&1; then
	source "${HOME}/bin/install_rust.sh"
fi

if ! bob --version >/dev/null 2>&1; then
	echo "Installing bob (neovim version manager)"
	# Unfortunately, binary versions have the wrong GLIBC
	#source "${HOME}/bin/update_bob.sh"
	cargo install --locked bob-nvim
fi

if ! nvim --version >/dev/null 2>&1; then
	echo "Installing neovim (nightly)"
	bob use nightly
fi

if ! tree-sitter -V >/dev/null 2>&1; then
	echo "Installing tree-sitter cli"
	cargo install tree-sitter-cli
fi

if ! silicon -V >/dev/null 2>&1; then
	echo "Installing silicon"
	cargo install silicon
fi

if ! python3 -c 'import pynvim;' >/dev/null 2>&1; then
	echo "Installing python neovim module"
	python3 -mpip install pynvim
fi

if ! nvr --version >/dev/null 2>&1; then
	echo "Installing neovim-remote"
	python3 -mpip install neovim-remote
fi

if ! node --version >/dev/null 2>&1; then
	source "${HOME}/bin/install_node.sh"
fi

{{ else }}

if ! nvim --version >/dev/null 2>&1; then
	echo "Installing neovim (nightly)"
	mise install neovim@nightly
	mise use -g neovim@nightly
fi

{{ end }}
