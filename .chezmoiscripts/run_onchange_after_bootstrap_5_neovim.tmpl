#! /usr/bin/env bash

# This script should install all necessary packages and tools for 
# the "neovim" version of the dotfiles

{{ if not (has "neovim" .global.roles)  -}}
exit 0
{{ end -}}

source "${HOME}/bin/helper.sh"
blue "bootstrap neovim"

if is_mac; then
	desired=(cmake shellcheck@0.9 shfmt@1.33 universal-ctags wordnet
		fontconfig@2.14)
	missing=()
	check_brewed "missing" "${desired[@]}"
	if [[ "${#missing[@]}" -gt 0 ]]; then
		echo "(brew) installing ${missing[*]}"
		brew install "${missing[@]}"
	fi
else
	source "/etc/os-release"
	if is_amzn; then
		{{- if eq .global.neovim "full" }}
			# cmake is needed for some neovim plugins
			# build-essential (at least C compiler) for tree-sitter
			# lib* are needed for compiling silicon
			desired=(cmake fontconfig
				fontconfig-devel
				libX11-xcb libX11-devel
				libxcb-devel
				harfbuzz-devel)
			if ! dnf group list --installed | grep -qFx "Development Tools"; then
				sudo dnf -y groupinstall "Development Tools"
			fi
		{{ else }}
			# unfortunately we need the C compiler from build-essential
			# to compile the treesitter parsers for languages
			desired=(gcc)
		{{ end }}
		missing=()
		check_dnfed "missing" "${desired[@]}"
		if [[ "${#missing[@]}" -gt 0 ]]; then
			echo "(dnf) installing ${missing[*]}"
			sudo dnf -y makecache
			sudo dnf -y install "${missing[@]}"
		fi
	else
		{{- if eq .global.neovim "full" }}
			# cmake is needed for some neovim plugins
			# build-essential (at least C compiler) for tree-sitter
			# lib* are needed for compiling silicon
			desired=(curl jq git unzip build-essential cmake fontconfig
				libfontconfig1-dev
				libx11-xcb-dev
				libxcb-render0-dev 
				libxcb-shape0-dev 
				libxcb-xfixes0-dev 
				libharfbuzz-dev)
		{{ else }}
			# unfortunately we need the C compiler from build-essential
			# to compile the treesitter parsers for languages
			desired=(curl jq git unzip gcc)
		{{ end }}
		missing=()
		check_dpkged "missing" "${desired[@]}"
		if [[ "${#missing[@]}" -gt 0 ]]; then
			echo "(apt) installing ${missing[*]}"
			sudo apt-get -y update
			sudo apt-get -y install "${missing[@]}"
		fi
	fi
fi

cd "${HOME}" || exit
# version manager for tools
if [[ ! -f "${HOME}/bin/mise" ]] || ! "${HOME}/bin/mise" --version >/dev/null 2>&1; then
	source "${HOME}/bin/update_mise.sh"
fi

# if we do not set those paths here, then all installed binaries
# that were installed using mise, cannot be found. We want to be able
# to rerun this script multiple times without errors
source "${HOME}/.path.d/10_rust.bash"
source "${HOME}/.path.d/50_mise.bash"
source "${HOME}/.path.d/99_default.sh"
eval "$(mise hook-env)"

# python is needed for installation of Mason packages as well
if ! grep -qs python ~/.config/mise/config.toml; then
	source "${HOME}/bin/install_python.sh"
fi

# node is needed to install tree-sitter binaries
if ! node --version >/dev/null 2>&1; then
	source "${HOME}/bin/install_node.sh"
fi

{{- if eq .global.neovim "full" }}

if ! rustup -V >/dev/null 2>&1; then
	source "${HOME}/bin/install_rust.sh"
fi

if ! is_mac && [[ "${VERSION_CODENAME}" == "buster" ]]; then
	echo "Compiling and installing neovim"
	cd "${HOME}" || exit
	mkdir -p "${HOME}/software/"
	cd "${HOME}/software/" || exit
	git clone --filter=tree:0 https://github.com/neovim/neovim neovim_src
	cd neovim_src || exit
	git checkout nightly
	make CMAKE_BUILD_TYPE=Release CMAKE_EXTRA_FLAGS="-DCMAKE_INSTALL_PREFIX=${HOME}/software/neovim"
	make install
	# ln -sf "${HOME}/software/neovim/bin/nvim" "${HOME}/bin/nvim"
else
	if ! bob --version >/dev/null 2>&1; then
		echo "Installing bob (neovim version manager)"
		# Unfortunately, binary versions have the wrong GLIBC
		#source "${HOME}/bin/update_bob.sh"
		cargo install --locked bob-nvim
	fi

	if ! nvim --version >/dev/null 2>&1; then
		echo "Installing neovim (nightly)"
		bob use nightly
	fi
fi

if ! tree-sitter -V >/dev/null 2>&1; then
	echo "Installing tree-sitter cli via cargo"
	cargo install tree-sitter-cli
fi

if ! silicon -V >/dev/null 2>&1; then
	echo "Installing silicon"
	cargo install silicon
fi

if ! python3 -c 'import pynvim;' >/dev/null 2>&1; then
	echo "Installing python neovim module"
	python3 -mpip install pynvim
fi

if ! nvr --version >/dev/null 2>&1; then
	echo "Installing neovim-remote"
	python3 -mpip install neovim-remote
fi

if ! is_mac; then
	echo "Updating font cache"
	if [[ -x /usr/bin/fc-cache ]]; then
		fc-cache -f
	fi
fi

{{ else }}

if ! nvim --version >/dev/null 2>&1; then
	echo "Installing neovim (nightly)"
	mise install neovim@nightly
	mise use -g neovim@nightly
fi

if ! tree-sitter --version >/dev/null 2>&1; then
	echo "Installing tree-sitter-cli via node"
	npm install -g tree-sitter-cli@0.25.10
fi

{{ end }}


